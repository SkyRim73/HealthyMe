<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zenith Habits - Final Polished UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* * ==============================================
         * AURORA UI - CSS VARIABLES & THEME SETUP
         * ==============================================
         */
        :root {
            --bg-primary: #0D1117;
            --card-bg: rgba(22, 27, 34, 0.65);
            --card-border: rgba(255, 255, 255, 0.1);
            --blur-intensity: 16px;
            --text-primary: #f0f6fc;
            --text-secondary: #c9d1d9;
            --text-tertiary: #8b949e;
            --accent-primary: #58a6ff;
            --accent-primary-glow: rgba(88, 166, 255, 0.5);
            --accent-success: #3fb950;
            --accent-success-glow: rgba(63, 185, 80, 0.5);
            --accent-danger: #f85149;
            --accent-danger-glow: rgba(248, 81, 73, 0.5);
            --accent-warning: #d29922;
            --accent-warning-glow: rgba(210, 153, 34, 0.5);
            --shadow-color: rgba(0, 0, 0, 0.3);
            --progress-bg: rgba(255, 255, 255, 0.1);
            --table-header-bg: rgba(30, 35, 42, 0.7);
            --row-highlight-bg: rgba(255, 255, 255, 0.03);
        }

        body.light {
            --bg-primary: #F7F9FC;
            --card-bg: rgba(255, 255, 255, 0.7);
            --card-border: rgba(0, 0, 0, 0.08);
            --blur-intensity: 20px;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-tertiary: #64748b;
            --accent-primary: #2563eb;
            --accent-primary-glow: rgba(37, 99, 235, 0.4);
            --accent-success: #16a34a;
            --accent-success-glow: rgba(22, 163, 74, 0.4);
            --accent-danger: #dc2626;
            --accent-danger-glow: rgba(220, 38, 38, 0.4);
            --accent-warning: #f59e0b;
            --accent-warning-glow: rgba(245, 158, 11, 0.4);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --progress-bg: rgba(0, 0, 0, 0.08);
            --table-header-bg: rgba(241, 245, 249, 0.8);
            --row-highlight-bg: rgba(0, 0, 0, 0.02);
        }

        /* * ==============================================
         * ANIMATED AURORA BACKGROUND
         * ==============================================
         */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle at 25% 25%, #1f6feb40, transparent 40%),
                        radial-gradient(circle at 75% 35%, #14b8a640, transparent 40%),
                        radial-gradient(circle at 20% 80%, #a855f740, transparent 40%),
                        radial-gradient(circle at 80% 70%, #ec489940, transparent 40%);
            z-index: -1;
            animation: aurora 20s linear infinite;
        }
        body.light::before {
             background: radial-gradient(circle at 25% 25%, #38bdf840, transparent 50%),
                        radial-gradient(circle at 75% 35%, #34d39940, transparent 50%),
                        radial-gradient(circle at 20% 80%, #c084fc40, transparent 50%),
                        radial-gradient(circle at 80% 70%, #f472b640, transparent 50%);
        }
        @keyframes aurora {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* * ==============================================
         * BASE & TYPOGRAPHY
         * ==============================================
         */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        
        h1 { text-shadow: 0 0 20px var(--accent-primary-glow); }
        h2, h3 { color: var(--text-primary); }
        label { color: var(--text-secondary); }

        .card {
            background-color: var(--card-bg);
            backdrop-filter: blur(var(--blur-intensity));
            -webkit-backdrop-filter: blur(var(--blur-intensity));
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--card-border);
            box-shadow: 0 8px 32px var(--shadow-color);
            transition: all 0.3s ease;
        }

        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border: 1px solid var(--card-border);
            border-radius: 12px;
            background-color: var(--card-bg);
        }

        table {
            border-collapse: separate;
            border-spacing: 0;
            min-width: 1400px;
        }
        
        th, td {
            padding: 12px 14px; text-align: center;
            font-size: 0.85rem; white-space: nowrap;
            transition: background-color 0.3s;
            border-bottom: 1px solid var(--card-border);
            border-right: 1px solid var(--card-border);
        }
        th:last-child, td:last-child { border-right: none; }
        tr:last-child td { border-bottom: none; }
        tbody tr:hover td { background-color: var(--row-highlight-bg); }

        th.habit-name-col { min-width: 200px; max-width: 250px; text-align: left; }
        th.day-header, td.day-cell { min-width: 48px; max-width: 48px; }

        .sticky-header th { position: sticky; top: 0; background-color: var(--table-header-bg); backdrop-filter: blur(var(--blur-intensity)); -webkit-backdrop-filter: blur(var(--blur-intensity)); z-index: 10; }
        .sticky-col { position: sticky; left: 0; background-color: var(--card-bg); z-index: 5; border-right: 2px solid var(--card-border); }
        tbody tr:hover .sticky-col { background-color: var(--row-highlight-bg); }
        .sticky-header .sticky-col { z-index: 15; background-color: var(--table-header-bg); }
        
        .weekend { background-color: rgba(0,0,0,0.1); }
        body.light .weekend { background-color: rgba(0,0,0,0.03); }
        .today { box-shadow: inset 0 0 0 2px var(--accent-primary); border-radius: 6px; }

        /* * ==============================================
         * CUSTOM COMPONENTS & INTERACTIVE ELEMENTS
         * ==============================================
         */

        /* Checkbox */
        .checkbox-cell { position: relative; }
        .checkbox-cell input[type="checkbox"] {
            appearance: none; -webkit-appearance: none;
            width: 24px; height: 24px;
            border: 2px solid var(--text-tertiary);
            border-radius: 6px; cursor: pointer; outline: none;
            transition: all 0.2s ease-in-out; vertical-align: middle;
        }
        .checkbox-cell input[type="checkbox"]:hover { border-color: var(--accent-primary); transform: scale(1.1); }
        .checkbox-cell input[type="checkbox"]:checked {
            background-color: var(--accent-success);
            border-color: var(--accent-success);
        }
        .checkbox-cell input[type="checkbox"]:checked::after {
            content: '✔'; font-size: 16px; font-weight: bold; color: #fff;
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Note Indicator */
        .note-indicator {
            position: absolute; top: 4px; right: 4px; width: 8px; height: 8px;
            background-color: var(--accent-primary); border-radius: 50%;
            display: none; cursor: pointer; border: 1px solid var(--bg-primary);
        }
        .has-note .note-indicator { display: block; }
        
        /* Progress Bar */
        .progress-bar-container { width: 100%; height: 8px; background-color: var(--progress-bg); border-radius: 8px; overflow: hidden; }

        /* Heatmap */
        .heatmap-cell { color: white; font-weight: 600; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }

        /* Buttons */
        .action-btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            color: var(--text-primary); padding: 10px 16px; border-radius: 8px;
            font-weight: 600; font-size: 0.875rem; 
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            cursor: pointer; transition: all 0.2s ease-in-out;
            text-shadow: none;
        }
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 20px -3px var(--glow-color, var(--accent-primary-glow));
            background-color: rgba(255, 255, 255, 0.1);
            border-color: var(--glow-border-color, var(--accent-primary));
        }
        .action-btn.btn-icon { padding: 10px; }

        /* Minimalist Icon buttons in lists */
        #habitListContainer .action-btn, #archivedHabitsContainer .action-btn {
            background-color: transparent;
            border: 1px solid transparent;
        }
        #habitListContainer .action-btn:hover, #archivedHabitsContainer .action-btn:hover {
            background-color: var(--glow-bg-color, rgba(255,255,255,0.1));
        }

        /* Inputs */
        input, select, textarea {
            background-color: rgba(0,0,0,0.2);
            border: 1px solid var(--card-border);
            color: var(--text-primary); padding: 10px 14px; border-radius: 8px;
            margin-bottom: 12px; width: 100%; transition: all 0.2s;
        }
        body.light input, body.light select, body.light textarea { background-color: rgba(255,255,255,0.5); }
        input:focus, select:focus, textarea:focus {
            outline: none; border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-primary-glow);
        }
        
        /* Modals */
        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; 
            background-color: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }
        .modal-content {
            background-color: var(--card-bg);
            backdrop-filter: blur(var(--blur-intensity));
            -webkit-backdrop-filter: blur(var(--blur-intensity));
            border: 1px solid var(--card-border);
            margin: 8% auto; padding: 30px; width: 90%; max-width: 550px;
            border-radius: 16px; color: var(--text-primary);
            box-shadow: 0 20px 40px var(--shadow-color);
            animation: slideUp 0.4s ease;
        }
        .modal-close-btn {
            color: var(--text-secondary); float: right; font-size: 28px; font-weight: bold;
            cursor: pointer; transition: color 0.2s; line-height: 1;
        }
        .modal-close-btn:hover { color: var(--text-primary); }

        /* Toast Notifications */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 200; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            background-color: var(--card-bg);
            backdrop-filter: blur(var(--blur-intensity));
            -webkit-backdrop-filter: blur(var(--blur-intensity));
            border: 1px solid var(--card-border);
            color: var(--text-primary); padding: 12px 20px; border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px;
            opacity: 0; transform: translateX(100%); animation: slideIn 0.5s forwards;
        }
        
        /* Empty State */
        .empty-state {
            border: 2px dashed var(--card-border); text-align: center;
            padding: 2rem; border-radius: 12px;
            background-color: rgba(0,0,0,0.1);
        }
        body.light .empty-state { background-color: transparent; }
        
        /* Theme Toggle Button */
        .theme-toggle-btn {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(var(--blur-intensity));
            -webkit-backdrop-filter: blur(var(--blur-intensity));
        }
        .theme-toggle-btn:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 0 15px -2px var(--accent-primary-glow);
        }
        .theme-toggle-btn svg {
            transition: transform 0.3s ease-in-out;
        }
        .theme-toggle-btn .sun-icon { display: none; }
        body.light .theme-toggle-btn .sun-icon { display: block; }
        body.light .theme-toggle-btn .moon-icon { display: none; }


        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideIn { to { opacity: 1; transform: translateX(0); } }
        @keyframes slideOut { to { opacity: 0; transform: translateX(100%); } }
    </style>
</head>
<body class="dark">

    <!-- All Modals -->
    <div id="toast-container"></div>
    <input type="file" id="importFileInput" class="hidden" accept=".json">
    <div id="loadingIndicator" class="fixed inset-0 bg-slate-900 bg-opacity-80 flex items-center justify-center z-[200]" style="display: none;">
        <div class="text-xl font-semibold text-white">Loading Tracker...</div>
    </div>
    <div id="noteModal" class="modal z-[190]"><div class="modal-content"><span class="modal-close-btn" id="closeNoteModal">&times;</span><h2 id="noteModalTitle" class="text-2xl font-bold mb-6">Add Note</h2><div><input type="hidden" id="noteHabitId"><input type="hidden" id="noteMonthKey"><input type="hidden" id="noteDayIndex"><textarea id="noteTextarea" placeholder="Add your notes for this day..." rows="5"></textarea><button id="saveNoteBtn" class="action-btn mt-4 w-full" style="--glow-color: var(--accent-primary-glow); --glow-border-color: var(--accent-primary);">Save Note</button></div></div></div>
    <div id="habitModal" class="modal z-[170]"><div class="modal-content"><span class="modal-close-btn" id="closeHabitModal">&times;</span><h2 id="habitModalTitle" class="text-2xl font-bold mb-6">Add New Habit</h2><div><input type="hidden" id="habitEditId"><label for="habitEmojiInput" class="font-semibold mb-1 block">Emoji:</label><input type="text" id="habitEmojiInput" placeholder="e.g., 💪" maxlength="2"><label for="habitNameInput" class="font-semibold mb-1 block">Habit Name:</label><input type="text" id="habitNameInput" placeholder="e.g., 1 Hr Working Out"><label for="habitGoalInput" class="font-semibold mb-1 block">Monthly Goal (days):</label><input type="number" id="habitGoalInput" placeholder="e.g., 20"><label for="habitMotivationInput" class="font-semibold mb-1 block">My Motivation (Why this habit?):</label><textarea id="habitMotivationInput" placeholder="e.g., To improve my physical health." rows="3"></textarea><button id="saveHabitBtn" class="action-btn mt-4 w-full" style="--glow-color: var(--accent-primary-glow); --glow-border-color: var(--accent-primary);">Save Habit</button></div></div></div>
    <div id="confirmationModal" class="modal z-[180]"><div class="modal-content"><span class="modal-close-btn" id="closeConfirmationModal">&times;</span><h2 id="confirmationModalTitle" class="text-2xl font-bold mb-4 text-amber-400">Confirm Action</h2><p id="confirmationModalMessage" class="text-text-secondary leading-relaxed mb-6"></p><div class="flex justify-end gap-4"><button id="cancelConfirmationBtn" class="action-btn" style="--glow-color: var(--text-tertiary);">Cancel</button><button id="confirmActionBtn" class="action-btn" style="--glow-color: var(--accent-danger-glow); --glow-border-color: var(--accent-danger);">Confirm</button></div></div></div>

    <!-- Main Content -->
    <div class="p-4 sm:p-6 lg:p-8">
        <header class="mb-10 relative">
            <div class="text-center">
                <h1 class="text-4xl sm:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-teal-300 to-sky-400">Zenith Habits</h1>
                <p class="text-lg text-text-secondary mt-2">Your daily progress, elevated.</p>
            </div>
            <div class="absolute top-0 right-0">
                <button id="theme-toggle" class="theme-toggle-btn" title="Toggle Theme">
                    <svg class="moon-icon w-6 h-6 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    <svg class="sun-icon w-6 h-6 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                </button>
            </div>
        </header>

        <main class="max-w-screen-2xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column -->
            <div class="lg:col-span-1 space-y-8">
                <div class="card">
                    <h2 class="text-2xl font-bold mb-4">Dashboard</h2>
                    <div class="space-y-6">
                        <div>
                            <label for="yearInput" class="text-base font-semibold">Select Year</label>
                            <div class="flex items-center gap-2 mt-1">
                                <input type="number" id="yearInput" class="w-full">
                                <button id="loadYearBtn" class="action-btn px-5" title="Load data for the selected year" style="--glow-color: var(--accent-primary-glow); --glow-border-color: var(--accent-primary);">Load</button>
                            </div>
                        </div>
                        <div>
                            <label class="text-base font-semibold">Manage Data</label>
                            <div class="flex items-center gap-3 mt-1">
                                <button id="exportDataBtn" class="action-btn w-full" title="Export current year's data" style="--glow-color: var(--accent-success-glow); --glow-border-color: var(--accent-success);"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg></span>Export</button>
                                <button id="importDataBtn" class="action-btn w-full" title="Import data from a file" style="--glow-color: var(--accent-warning-glow); --glow-border-color: var(--accent-warning);"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m-4 4v-7a4 4 0 014-4h4" /></svg></span>Import</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="overviewCard" class="card"></div>
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Habits</h2>
                        <button id="openAddHabitModalBtn" class="action-btn text-base" title="Add a new habit" style="--glow-color: var(--accent-primary-glow); --glow-border-color: var(--accent-primary);"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg></span>Add</button>
                    </div>
                    <div id="habitListContainer" class="space-y-1"></div>
                    <div id="archivedHabitsContainer" class="mt-6"></div>
                </div>
            </div>
            <!-- Right Column -->
            <div class="lg:col-span-2 space-y-8">
                <div id="heatmapCard" class="card"></div>
                <div id="monthsContainer" class="space-y-8"></div>
            </div>
        </main>

        <footer class="mt-16 text-center text-sm text-text-secondary">
            <p>Zenith Habits Tracker. All data is stored securely in your browser.</p>
        </footer>
    </div>

    <script>
        // --- App State & Constants ---
        const APP_ID = 'zenith-habits-tracker-pro';
        let currentYear = new Date().getFullYear();
        let habitsConfig = [];
        let allHabitDataForYear = {};
        let isDataInitialized = false;
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        // --- DOM Elements ---
        const DOMElements = {
            body: document.body,
            loadingIndicator: document.getElementById('loadingIndicator'),
            monthsContainer: document.getElementById('monthsContainer'),
            yearInput: document.getElementById('yearInput'),
            loadYearBtn: document.getElementById('loadYearBtn'),
            exportDataBtn: document.getElementById('exportDataBtn'),
            importDataBtn: document.getElementById('importDataBtn'),
            importFileInput: document.getElementById('importFileInput'),
            habitListContainer: document.getElementById('habitListContainer'),
            archivedHabitsContainer: document.getElementById('archivedHabitsContainer'),
            openAddHabitModalBtn: document.getElementById('openAddHabitModalBtn'),
            toastContainer: document.getElementById('toast-container'),
            heatmapContainer: document.getElementById('heatmapCard'),
            overviewCard: document.getElementById('overviewCard'),
            themeToggle: document.getElementById('theme-toggle'),
        };

        // --- SVG Icons ---
        const icons = {
            edit: `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>`,
            delete: `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>`,
            archive: `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m20.25 7.5-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z" /></svg>`,
            unarchive: `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m20.25 7.5-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M12 18.75m-3-3h6M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z" /></svg>`,
        };

        // --- Utility & Data Functions ---
        const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
        const getDayName = (year, month, day) => new Date(year, month, day).toLocaleDateString('en-US', { weekday: 'short' });
        const showToast = (message, type = 'success') => {
            const toast = document.createElement('div');
            const toastColor = type === 'error' ? 'border-rose-500' : 'border-slate-600';
            toast.className = `toast ${toastColor}`;
            toast.textContent = message;
            DOMElements.toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.5s forwards';
                toast.addEventListener('animationend', () => toast.remove());
            }, 3000);
        };
        
        function loadInitialData() {
            // Create some default habits if none exist
            habitsConfig = [
                { id: crypto.randomUUID(), name: "1 Hr Working Out", emoji: "💪", monthlyGoal: 20, isArchived: false, motivation: "To build strength and improve cardiovascular health." },
                { id: crypto.randomUUID(), name: "Hit 10,000 steps", emoji: "🚶‍♂️", monthlyGoal: 25, isArchived: false, motivation: "For better overall fitness and mental clarity." },
                { id: crypto.randomUUID(), name: "Sleep Before 10:30 PM", emoji: "😴", monthlyGoal: 22, isArchived: false, motivation: "To ensure I get enough rest for recovery and focus." },
                { id: crypto.randomUUID(), name: "Read 10 Pages", emoji: "📚", monthlyGoal: 30, isArchived: true, motivation: "To constantly learn and expand my knowledge." },
                { id: crypto.randomUUID(), name: "Drink 3L Water", emoji: "💧", monthlyGoal: 30, isArchived: false, motivation: "To stay hydrated and support bodily functions." },
            ];
            allHabitDataForYear = {};
            initializeAndNormalizeData();
            saveDataToLocalStorage();
        }

        function loadDataFromLocalStorage() {
            const key = `${APP_ID}_${currentYear}`;
            const data = localStorage.getItem(key);
            if (data) {
                try {
                    const parsedData = JSON.parse(data);
                    // Basic validation to ensure the data structure is what we expect
                    if (parsedData.habitsConfig && Array.isArray(parsedData.habitsConfig)) {
                        habitsConfig = parsedData.habitsConfig;
                        allHabitDataForYear = parsedData.allHabitDataForYear || {};
                    } else { loadInitialData(); }
                } catch (e) { 
                    console.error("Failed to parse localStorage data:", e);
                    loadInitialData(); 
                }
            } else { loadInitialData(); }
        }

        function saveDataToLocalStorage() {
            if (!isDataInitialized) return;
            const key = `${APP_ID}_${currentYear}`;
            const dataToSave = { habitsConfig, allHabitDataForYear };
            try {
                localStorage.setItem(key, JSON.stringify(dataToSave));
            } catch (e) {
                console.error("Failed to save to localStorage:", e);
                showToast("Could not save data. Your browser storage might be full.", "error");
            }
        }
        
        // --- App Initialization & Rendering ---
        window.onload = () => {
            DOMElements.yearInput.value = currentYear;
            const savedTheme = localStorage.getItem('theme') || 'dark';
            setTheme(savedTheme);
            loadDataForCurrentYear();
        };

        function loadDataForCurrentYear() {
            DOMElements.loadingIndicator.style.display = "flex";
            isDataInitialized = false;
            // Use a timeout to ensure the loading indicator is visible before the main thread is blocked
            setTimeout(() => {
                loadDataFromLocalStorage();
                initializeAndNormalizeData();
                isDataInitialized = true;
                renderApp();
                DOMElements.loadingIndicator.style.display = "none";
            }, 50);
        }

        function initializeAndNormalizeData() {
            // This function ensures data integrity for the current year
            habitsConfig.forEach(habit => {
                // Ensure every habit has an `isArchived` property
                if (habit.isArchived === undefined) habit.isArchived = false;
                
                // Initialize data structure for the habit if it doesn't exist
                if (!allHabitDataForYear[habit.id]) allHabitDataForYear[habit.id] = { months: {} };
                const habitTracking = allHabitDataForYear[habit.id];
                if (!habitTracking.months) habitTracking.months = {};

                // Ensure data for all 12 months of the year is present and correct
                monthNames.forEach((_, monthIndex) => {
                    const monthKey = `${currentYear}-${String(monthIndex + 1).padStart(2, '0')}`;
                    const daysInThisMonth = getDaysInMonth(currentYear, monthIndex);
                    
                    // If month data is missing, or day count is wrong, reset it
                    if (!habitTracking.months[monthKey] || !habitTracking.months[monthKey].days || habitTracking.months[monthKey].days.length !== daysInThisMonth) {
                        habitTracking.months[monthKey] = { days: Array(daysInThisMonth).fill(false), notes: {} };
                    }
                    // Ensure notes object exists
                    if(!habitTracking.months[monthKey].notes) habitTracking.months[monthKey].notes = {};
                    
                    // Recalculate stats for this month
                    calculateAllStats(habit.id, monthKey);
                });
            });
        }

        function renderApp() {
            if (!isDataInitialized) return;
            renderHabitList();
            renderArchivedHabitList();
            renderOverviewCard();
            renderHeatmap();
            renderAllMonths();
        }
        
        function renderAllMonths() {
            DOMElements.monthsContainer.innerHTML = '';
            const activeHabits = habitsConfig.filter(h => !h.isArchived);
            if (activeHabits.length > 0) {
                 monthNames.forEach((monthName, monthIndex) => {
                    const monthCard = document.createElement('div');
                    monthCard.className = 'card';
                    monthCard.innerHTML = `<h3 class="text-3xl font-bold text-center mb-6">${monthName} ${currentYear}</h3><div class="table-container"><table class="w-full" data-month-index="${monthIndex}"></table></div>`;
                    DOMElements.monthsContainer.appendChild(monthCard);
                    const table = monthCard.querySelector('table');
                    renderMonth(table, monthIndex);
                });
            } else {
                DOMElements.monthsContainer.innerHTML = `<div class="card lg:col-span-2"><div class="empty-state"><h3 class="text-xl font-bold">No Active Habits</h3><p class="text-text-secondary mt-2">Add or unarchive a habit to start tracking!</p></div></div>`;
            }
        }

        // --- UI Component Rendering ---
        function renderHabitList() {
            const activeHabits = habitsConfig.filter(h => !h.isArchived);
            DOMElements.habitListContainer.innerHTML = '';
            if (activeHabits.length === 0) {
                DOMElements.habitListContainer.innerHTML = `<div class="empty-state text-sm"><p class="text-text-secondary">No active habits.</p></div>`;
                return;
            }
            activeHabits.forEach(habit => {
                const li = document.createElement('div');
                li.className = 'flex flex-col sm:flex-row justify-between sm:items-center p-3 rounded-lg transition-all duration-300 hover:bg-white/5';
                li.innerHTML = `
                    <div class="flex items-center gap-4">
                        <span class="text-3xl">${habit.emoji || '🎯'}</span>
                        <div>
                            <span class="font-semibold block text-text-primary">${habit.name}</span>
                            <span class="text-sm text-text-secondary block">(Goal: ${habit.monthlyGoal} days)</span>
                        </div>
                    </div>
                    <div class="mt-3 sm:mt-0 flex gap-1 self-end sm:self-center">
                        <button class="action-btn btn-icon" data-action="edit" data-habit-id="${habit.id}" title="Edit Habit" style="--glow-color: var(--accent-warning-glow); --glow-border-color: var(--accent-warning); --glow-bg-color: rgba(210, 153, 34, 0.1);">${icons.edit}</button>
                        <button class="action-btn btn-icon" data-action="archive" data-habit-id="${habit.id}" title="Archive Habit" style="--glow-color: rgba(139, 148, 158, 0.5); --glow-border-color: var(--text-tertiary); --glow-bg-color: rgba(139, 148, 158, 0.1);">${icons.archive}</button>
                    </div>
                `;
                DOMElements.habitListContainer.appendChild(li);
            });
        }

        function renderArchivedHabitList() {
             const archivedHabits = habitsConfig.filter(h => h.isArchived);
             DOMElements.archivedHabitsContainer.innerHTML = '';
             if (archivedHabits.length > 0) {
                 let listHTML = `<h3 class="text-xl font-bold mt-6 mb-3 text-text-secondary">Archived Habits</h3>`;
                 archivedHabits.forEach(habit => {
                     listHTML += `
                        <div class="flex justify-between items-center p-3 rounded-lg mb-1 opacity-60 hover:opacity-100 transition-opacity hover:bg-white/5">
                             <div class="flex items-center gap-4">
                                <span class="text-2xl opacity-50">${habit.emoji || '🎯'}</span>
                                <div><span class="font-semibold block text-text-secondary line-through">${habit.name}</span></div>
                            </div>
                            <div class="flex gap-1">
                                <button class="action-btn btn-icon" data-action="unarchive" data-habit-id="${habit.id}" title="Unarchive Habit" style="--glow-color: var(--accent-success-glow); --glow-border-color: var(--accent-success); --glow-bg-color: rgba(63, 185, 80, 0.1);">${icons.unarchive}</button>
                                <button class="action-btn btn-icon" data-action="delete" data-habit-id="${habit.id}" title="Delete Permanently" style="--glow-color: var(--accent-danger-glow); --glow-border-color: var(--accent-danger); --glow-bg-color: rgba(248, 81, 73, 0.1);">${icons.delete}</button>
                            </div>
                        </div>
                     `;
                 });
                 DOMElements.archivedHabitsContainer.innerHTML = listHTML;
             }
        }
        
        function renderOverviewCard() {
            const overview = calculateYearlyOverview();
            let content;
            if (overview.totalHabits === 0) {
                 content = `<h2 class="text-2xl font-bold mb-4">Yearly Overview</h2><div class="empty-state"><p class="text-text-secondary">No data to display.</p></div>`;
            } else {
                content = `
                    <h2 class="text-2xl font-bold mb-4">Yearly Overview</h2>
                    <div class="space-y-4">
                        <div class="flex justify-between items-baseline">
                            <span class="font-medium text-text-secondary">Overall Completion</span>
                            <span class="font-bold text-2xl" style="color: var(--accent-success); text-shadow: 0 0 8px var(--accent-success-glow);">${overview.overallCompletion.toFixed(1)}%</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-text-secondary">Best Habit</span>
                            <span class="font-semibold text-right" style="color: var(--accent-success);">${overview.bestHabit.name || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-text-secondary">Needs Focus</span>
                            <span class="font-semibold text-right" style="color: var(--accent-danger);">${overview.worstHabit.name || 'N/A'}</span>
                        </div>
                         <div class="flex justify-between items-baseline">
                            <span class="font-medium text-text-secondary">Total Days Tracked</span>
                            <span class="font-bold text-2xl" style="color: var(--accent-primary); text-shadow: 0 0 8px var(--accent-primary-glow);">${overview.totalDaysTracked}</span>
                        </div>
                    </div>
                `;
            }
            DOMElements.overviewCard.innerHTML = content;
        }

        function renderHeatmap() {
            const activeHabits = habitsConfig.filter(h => !h.isArchived);
            let content = `<h2 class="text-2xl font-bold mb-4">Performance Heatmap</h2>`;
            if (activeHabits.length === 0) {
                content += `<div class="empty-state"><p class="text-text-secondary">No habits to display.</p></div>`;
                DOMElements.heatmapContainer.innerHTML = content;
                return;
            }
            
            let tableHTML = `<div class="table-container"><table class="w-full" style="min-width: 800px;"><thead><tr class="sticky-header">
                <th class="sticky-col habit-name-col text-left">Habit</th>
                ${monthNames.map(m => `<th class="w-16">${m.substring(0,3)}</th>`).join('')}
            </tr></thead><tbody>`;

            activeHabits.forEach(habit => {
                tableHTML += `<tr><td class="sticky-col habit-name-col text-left font-semibold">${habit.emoji || '🎯'} ${habit.name}</td>`;
                for (let i = 0; i < 12; i++) {
                    const monthKey = `${currentYear}-${String(i + 1).padStart(2, '0')}`;
                    const daysInMonth = getDaysInMonth(currentYear, i);
                    const monthData = allHabitDataForYear[habit.id]?.months?.[monthKey];
                    const total = monthData?.total || 0;
                    const compliance = (total / daysInMonth) * 100;
                    
                    let color;
                    if (compliance >= 75) color = 'var(--accent-success)';
                    else if (compliance >= 40) color = 'var(--accent-warning)';
                    else color = 'var(--accent-danger)';
                    
                    const alpha = compliance > 0 ? Math.max(0.3, compliance / 100).toFixed(2) : 0.05;
                    const bgColor = `color-mix(in srgb, ${color} ${alpha * 100}%, transparent)`;

                    tableHTML += `<td class="heatmap-cell" style="background-color: ${bgColor}" title="${monthNames[i]}: ${total}/${daysInMonth} days">${compliance.toFixed(0)}%</td>`;
                }
                tableHTML += `</tr>`;
            });
            tableHTML += `</tbody></table></div>`;
            DOMElements.heatmapContainer.innerHTML = content + tableHTML;
        }

        function renderMonth(table, monthIndex) {
            const activeHabits = habitsConfig.filter(h => !h.isArchived);
            const daysInThisMonth = getDaysInMonth(currentYear, monthIndex);
            const today = new Date();
            const isCurrentMonthForToday = today.getFullYear() === currentYear && today.getMonth() === monthIndex;
            const todayDate = today.getDate();

            // Table headers
            let headerHTML = `<tr class="sticky-header">
                <th rowspan="2" class="sticky-col habit-name-col">Habit</th>
                ${Array.from({length: daysInThisMonth}, (_, i) => `<th class="day-header ${getDayName(currentYear, monthIndex, i+1).match(/S(at|un)/) ? 'weekend' : ''} ${isCurrentMonthForToday && i+1 === todayDate ? 'today' : ''}">${i+1}</th>`).join('')}
                <th rowspan="2" class="!min-w-[60px]">Total</th><th rowspan="2" class="!min-w-[60px]">Current</th><th rowspan="2" class="!min-w-[60px]">Longest</th><th rowspan="2" class="!min-w-[60px]">Goal</th><th rowspan="2" class="!min-w-[120px]">Progress</th><th rowspan="2" class="!min-w-[80px]">Phase</th>
            </tr>
            <tr class="sticky-header">
                ${Array.from({length: daysInThisMonth}, (_, i) => `<th class="day-header ${getDayName(currentYear, monthIndex, i+1).match(/S(at|un)/) ? 'weekend' : ''} ${isCurrentMonthForToday && i+1 === todayDate ? 'today' : ''}">${getDayName(currentYear, monthIndex, i+1)}</th>`).join('')}
            </tr>`;
            
            // Table body
            let bodyHTML = '';
            activeHabits.forEach(habitDef => {
                const monthKey = `${currentYear}-${String(monthIndex + 1).padStart(2, '0')}`;
                const habitMonthData = allHabitDataForYear[habitDef.id]?.months?.[monthKey];
                if (!habitMonthData) return;

                let rowHTML = `<tr data-habit-id="${habitDef.id}" data-month-key="${monthKey}">`;
                rowHTML += `<td class="sticky-col habit-name-col text-left py-3 px-4 text-base font-semibold">${habitDef.emoji || '🎯'} ${habitDef.name}</td>`;
                
                for (let day = 0; day < daysInThisMonth; day++) {
                    const isChecked = habitMonthData.days[day];
                    const hasNote = habitMonthData.notes[day];
                    rowHTML += `<td class="checkbox-cell day-cell ${getDayName(currentYear, monthIndex, day + 1).match(/S(at|un)/) ? 'weekend' : ''} ${isCurrentMonthForToday && (day + 1) === todayDate ? 'today' : ''} ${hasNote ? 'has-note' : ''}" data-habit-id="${habitDef.id}" data-month-key="${monthKey}" data-day-index="${day}">
                        <input type="checkbox" data-action="check" title="${monthNames[monthIndex]} ${day + 1}" ${isChecked ? 'checked' : ''}>
                        <span class="note-indicator" data-action="note" title="View/Edit Note"></span>
                    </td>`;
                }

                const progressPercent = habitDef.monthlyGoal > 0 ? (habitMonthData.total / habitDef.monthlyGoal) * 100 : 0;
                const compliance = (habitMonthData.total / daysInThisMonth) * 100;
                let phaseHTML;
                if (compliance >= 75) phaseHTML = `<span class="font-semibold" style="color: var(--accent-success);">Mastery</span>`;
                else if (compliance >= 40) phaseHTML = `<span class="font-semibold" style="color: var(--accent-warning);">Building</span>`;
                else phaseHTML = `<span class="font-semibold" style="color: var(--accent-danger);">Starting</span>`;

                rowHTML += `<td class="font-bold">${habitMonthData.total}</td><td>${habitMonthData.currentStreak}</td><td>${habitMonthData.longestStreak}</td><td>${habitDef.monthlyGoal}</td>
                <td>
                    <div class="w-full flex items-center gap-2">
                        <div class="progress-bar-container flex-1"><div class="bg-green-500 h-full rounded-md" style="width: ${Math.min(progressPercent, 100)}%;"></div></div>
                        <span class="text-xs font-semibold">${progressPercent.toFixed(0)}%</span>
                    </div>
                </td>
                <td>${phaseHTML}</td></tr>`;
                bodyHTML += rowHTML;
            });

            table.innerHTML = `<thead>${headerHTML}</thead><tbody>${bodyHTML}</tbody>`;
        }
        
        // --- Calculation Functions ---
        function calculateAllStats(habitId, monthKey) {
            const monthData = allHabitDataForYear[habitId]?.months?.[monthKey];
            if (!monthData) return;
            
            const daysArray = monthData.days;
            monthData.total = daysArray.filter(Boolean).length;
            
            let longestStreak = 0, currentRun = 0;
            daysArray.forEach(dayDone => {
                if (dayDone) currentRun++;
                else { longestStreak = Math.max(longestStreak, currentRun); currentRun = 0; }
            });
            monthData.longestStreak = Math.max(longestStreak, currentRun);

            let currentStreak = 0;
            const today = new Date();
            const [yearStr, monthStr] = monthKey.split('-');
            const monthYear = parseInt(yearStr), monthIndex = parseInt(monthStr) - 1;
            
            let lastRelevantDayIndex = -1;
            if (new Date(monthYear, monthIndex) < new Date(today.getFullYear(), today.getMonth())) {
                lastRelevantDayIndex = daysArray.length - 1;
            } else if (monthYear === today.getFullYear() && monthIndex === today.getMonth()) {
                lastRelevantDayIndex = today.getDate() - 1;
            }

            if (lastRelevantDayIndex >= 0) {
                currentStreak = 0;
                for (let i = lastRelevantDayIndex; i >= 0; i--) {
                    if (daysArray[i]) currentStreak++;
                    else break;
                }
            }
            monthData.currentStreak = currentStreak;
        }

        function calculateYearlyOverview() {
            const activeHabits = habitsConfig.filter(h => !h.isArchived);
            if (activeHabits.length === 0) return { totalHabits: 0, overallCompletion: 0, bestHabit: {}, worstHabit: {}, totalDaysTracked: 0 };

            let totalPossibleDays = 0;
            let totalCompletedDays = 0;
            const habitStats = [];

            activeHabits.forEach(habit => {
                let habitTotalDays = 0;
                let habitPossibleDays = 0;
                Object.values(allHabitDataForYear[habit.id]?.months || {}).forEach(month => {
                    habitTotalDays += month.total || 0;
                    habitPossibleDays += month.days.length;
                });
                totalCompletedDays += habitTotalDays;
                totalPossibleDays += habitPossibleDays;
                habitStats.push({ name: habit.name, compliance: (habitTotalDays / habitPossibleDays) * 100 || 0 });
            });
            
            habitStats.sort((a, b) => b.compliance - a.compliance);

            return {
                totalHabits: activeHabits.length,
                overallCompletion: (totalCompletedDays / totalPossibleDays) * 100 || 0,
                bestHabit: habitStats[0] || {},
                worstHabit: habitStats[habitStats.length - 1] || {},
                totalDaysTracked: totalCompletedDays
            };
        }

        // --- Modal & Form Logic ---
        function openModal(modalId) { document.getElementById(modalId).style.display = "block"; }
        function closeModal(modalId) { document.getElementById(modalId).style.display = "none"; }

        function openHabitModal(mode, habitId = null) {
            const modal = document.getElementById('habitModal');
            modal.querySelector('#habitEditId').value = '';
            modal.querySelector('#habitEmojiInput').value = '';
            modal.querySelector('#habitNameInput').value = '';
            modal.querySelector('#habitGoalInput').value = '';
            modal.querySelector('#habitMotivationInput').value = '';

            if (mode === 'edit') {
                const habit = habitsConfig.find(h => h.id === habitId);
                if (!habit) return;
                modal.querySelector('#habitModalTitle').textContent = "Edit Habit";
                modal.querySelector('#habitEditId').value = habit.id;
                modal.querySelector('#habitEmojiInput').value = habit.emoji || '';
                modal.querySelector('#habitNameInput').value = habit.name;
                modal.querySelector('#habitGoalInput').value = habit.monthlyGoal;
                modal.querySelector('#habitMotivationInput').value = habit.motivation || '';
            } else {
                modal.querySelector('#habitModalTitle').textContent = "Add New Habit";
            }
            openModal('habitModal');
            modal.querySelector('#habitEmojiInput').focus();
        }

        function handleSaveHabit() {
            const modal = document.getElementById('habitModal');
            const name = modal.querySelector('#habitNameInput').value.trim();
            const emoji = modal.querySelector('#habitEmojiInput').value.trim();
            const monthlyGoal = parseInt(modal.querySelector('#habitGoalInput').value);
            const motivation = modal.querySelector('#habitMotivationInput').value.trim();
            const editId = modal.querySelector('#habitEditId').value;

            if (!name || isNaN(monthlyGoal) || monthlyGoal <= 0) {
                showToast("Please enter a valid name and goal.", "error"); return;
            }

            if (editId) {
                const index = habitsConfig.findIndex(h => h.id === editId);
                if (index > -1) habitsConfig[index] = { ...habitsConfig[index], name, emoji, monthlyGoal, motivation };
            } else {
                const newHabit = { id: crypto.randomUUID(), name, emoji, monthlyGoal, motivation, isArchived: false };
                habitsConfig.push(newHabit);
                allHabitDataForYear[newHabit.id] = { months: {} }; // Initialize data for new habit
                initializeAndNormalizeData(); // Populate months for the new habit
            }
            
            saveDataToLocalStorage();
            renderApp();
            closeModal('habitModal');
            showToast(`Habit "${name}" saved successfully!`);
        }
        
        function openNoteModal(habitId, monthKey, dayIndex) {
            const modal = document.getElementById('noteModal');
            const habit = habitsConfig.find(h => h.id === habitId);
            const date = new Date(currentYear, monthKey.split('-')[1] - 1, parseInt(dayIndex) + 1);
            
            modal.querySelector('#noteModalTitle').textContent = `Note for ${habit.name} on ${date.toLocaleDateString()}`;
            modal.querySelector('#noteHabitId').value = habitId;
            modal.querySelector('#noteMonthKey').value = monthKey;
            modal.querySelector('#noteDayIndex').value = dayIndex;
            
            const note = allHabitDataForYear[habitId]?.months[monthKey]?.notes[dayIndex] || '';
            modal.querySelector('#noteTextarea').value = note;
            
            openModal('noteModal');
            modal.querySelector('#noteTextarea').focus();
        }
        
        function handleSaveNote() {
            const modal = document.getElementById('noteModal');
            const habitId = modal.querySelector('#noteHabitId').value;
            const monthKey = modal.querySelector('#noteMonthKey').value;
            const dayIndex = modal.querySelector('#noteDayIndex').value;
            const noteText = modal.querySelector('#noteTextarea').value.trim();
            
            const monthData = allHabitDataForYear[habitId]?.months[monthKey];
            if(monthData) {
                if(noteText) {
                    monthData.notes[dayIndex] = noteText;
                } else {
                    delete monthData.notes[dayIndex];
                }
                saveDataToLocalStorage();
                // Targeted update instead of full renderApp()
                const cell = document.querySelector(`.checkbox-cell[data-habit-id="${habitId}"][data-month-key="${monthKey}"][data-day-index="${dayIndex}"]`);
                if (cell) cell.classList.toggle('has-note', !!noteText);
                closeModal('noteModal');
                showToast('Note saved!');
            }
        }

        function showConfirmationModal(message, callback, confirmText = "Confirm") {
            document.getElementById('confirmationModalMessage').textContent = message;
            const confirmBtn = document.getElementById('confirmActionBtn');
            confirmBtn.textContent = confirmText;
            window.confirmationCallback = callback;
            openModal('confirmationModal');
        }
        
        // --- Data & Theme Management ---
        function handleDataAction(action, habitId) {
            const habit = habitsConfig.find(h => h.id === habitId);
            if (!habit) return;
            
            switch(action) {
                case 'edit': openHabitModal('edit', habitId); break;
                case 'archive':
                    habit.isArchived = true;
                    saveDataToLocalStorage(); renderApp(); showToast(`"${habit.name}" archived.`); break;
                case 'unarchive':
                    habit.isArchived = false;
                    saveDataToLocalStorage(); renderApp(); showToast(`"${habit.name}" restored.`); break;
                case 'delete':
                    showConfirmationModal(`Permanently delete "${habit.name}" and all its data? This cannot be undone.`, () => {
                        habitsConfig = habitsConfig.filter(h => h.id !== habitId);
                        delete allHabitDataForYear[habitId];
                        saveDataToLocalStorage(); renderApp(); showToast(`Habit "${habit.name}" deleted.`, 'success');
                    }, "Delete Forever");
                    break;
            }
        }

        function setTheme(theme) {
            localStorage.setItem('theme', theme);
            DOMElements.body.className = theme;
        }
        
        // --- Event Listeners ---
        DOMElements.loadYearBtn.addEventListener('click', () => {
            const newYear = parseInt(DOMElements.yearInput.value);
            if (isNaN(newYear) || newYear < 1900 || newYear > 2200) {
                showToast("Please enter a valid year.", "error");
                return;
            }
            currentYear = newYear; 
            loadDataForCurrentYear();
        });

        DOMElements.exportDataBtn.addEventListener('click', () => {
             if (habitsConfig.length === 0) { showToast("No habits to export.", "error"); return; }
            const data = JSON.stringify({ habitsConfig, allHabitDataForYear }, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `zenith-habits-data-${currentYear}.json`; a.click();
            URL.revokeObjectURL(url); showToast(`Exported data for ${currentYear}.`);
        });

        DOMElements.importDataBtn.addEventListener('click', () => DOMElements.importFileInput.click());
        
        DOMElements.importFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.habitsConfig || !data.allHabitDataForYear) throw new Error("Invalid file format.");
                    showConfirmationModal(`This will overwrite all habit data for ${currentYear}. Are you sure?`, () => {
                        habitsConfig = data.habitsConfig; allHabitDataForYear = data.allHabitDataForYear;
                        isDataInitialized = true; // Mark as initialized before saving
                        saveDataToLocalStorage(); 
                        loadDataForCurrentYear(); // Reload to normalize and render
                        showToast(`Successfully imported data.`);
                    }, "Import & Overwrite");
                } catch (err) { showToast(`Error importing file: ${err.message}`, "error"); }
            };
            reader.readAsText(file); event.target.value = '';
        });

        DOMElements.themeToggle.addEventListener('click', () => setTheme(DOMElements.body.classList.contains('dark') ? 'light' : 'dark'));

        // Modal & Delegated Listeners
        document.getElementById('saveHabitBtn').addEventListener('click', handleSaveHabit);
        document.getElementById('saveNoteBtn').addEventListener('click', handleSaveNote);
        
        DOMElements.habitListContainer.addEventListener('click', e => {
            const button = e.target.closest('button[data-habit-id]');
            if(button) handleDataAction(button.dataset.action, button.dataset.habitId);
        });
        
        DOMElements.archivedHabitsContainer.addEventListener('click', e => {
            const button = e.target.closest('button[data-habit-id]');
            if(button) handleDataAction(button.dataset.action, button.dataset.habitId);
        });

        DOMElements.monthsContainer.addEventListener('click', e => {
            const target = e.target;
            const cell = target.closest('.checkbox-cell');
            if (!cell) return;
            const { habitId, monthKey, dayIndex } = cell.dataset;
            
            if(target.dataset.action === 'note') {
                 openNoteModal(habitId, monthKey, dayIndex);
            } else if (target.type === 'checkbox') {
                 const habitTracking = allHabitDataForYear[habitId];
                if (habitTracking?.months[monthKey]) {
                    habitTracking.months[monthKey].days[parseInt(dayIndex)] = target.checked;
                    calculateAllStats(habitId, monthKey);
                    saveDataToLocalStorage();
                    
                    // Targeted updates for better performance
                    renderOverviewCard();
                    renderHeatmap();
                    const table = cell.closest('table');
                    const monthIndex = parseInt(table.dataset.monthIndex);
                    renderMonth(table, monthIndex);
                }
            }
        });
        
        // Generic Modal Closing
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal || e.target.classList.contains('modal-close-btn')) {
                    closeModal(modal.id);
                }
            });
        });
        document.getElementById('cancelConfirmationBtn').addEventListener('click', () => closeModal('confirmationModal'));
        document.getElementById('confirmActionBtn').addEventListener('click', () => {
             if (window.confirmationCallback) window.confirmationCallback();
             closeModal('confirmationModal');
        });
        DOMElements.openAddHabitModalBtn.addEventListener('click', () => openHabitModal('add'));
    </script>
</body>
</html>

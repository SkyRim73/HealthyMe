<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Habits Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #f3f4f6; /* text-gray-100 */
        }
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        table {
            border-collapse: separate;
            border-spacing: 0;
            min-width: 1300px;
        }
        th, td {
            border: 1px solid #374151; /* border-gray-700 */
            padding: 6px 8px;
            text-align: center;
            font-size: 0.8rem;
        }
        th.habit-name-col {
            min-width: 180px; max-width: 230px; text-align: left; white-space: normal; word-break: break-word;
        }
        th.day-header, td.day-cell { min-width: 35px; max-width: 35px; }
        th.stats-col { min-width: 55px; font-size: 0.75rem; }
        th.action-col, td.action-cell { min-width: 100px; }
        .checkbox-cell input[type="checkbox"] {
            appearance: none; -webkit-appearance: none; width: 18px; height: 18px;
            border: 2px solid #4b5563; border-radius: 4px; cursor: pointer; outline: none;
            transition: background-color 0.2s, border-color 0.2s; vertical-align: middle;
        }
        .checkbox-cell input[type="checkbox"]:checked {
            background-color: #10b981; border-color: #059669; position: relative;
        }
        .checkbox-cell input[type="checkbox"]:checked::after {
            content: '✔'; font-size: 12px; color: white; position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        .weekend { background-color: #1f2937; }
        .today { border-left: 2px solid #3b82f6; border-right: 2px solid #3b82f6; }
        .sticky-header th { position: sticky; top: 0; background-color: #1f2937; z-index: 10; }
        .sticky-col { position: sticky; left: 0; background-color: #1f2937; z-index: 5; }
        .sticky-header .sticky-col { z-index: 15; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7);
        }
        .modal-content {
            background-color: #1f2937; margin: 10% auto; padding: 25px;
            border: 1px solid #374151; width: 90%; max-width: 550px;
            border-radius: 10px; color: #f3f4f6; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .modal-close-btn {
            color: #9ca3af; float: right; font-size: 28px; font-weight: bold; line-height: 1;
        }
        .modal-close-btn:hover, .modal-close-btn:focus {
            color: #e5e7eb; text-decoration: none; cursor: pointer;
        }
        .ai-tip-btn, .action-btn {
            background-color: #3b82f6; color: white; padding: 4px 8px; border-radius: 5px;
            font-size: 0.75rem; border: none; cursor: pointer; transition: background-color 0.2s;
        }
        .ai-tip-btn:hover, .action-btn:hover { background-color: #2563eb; }
        .ai-tip-btn:disabled, .action-btn:disabled { background-color: #4b5563; cursor: not-allowed; }
        .delete-btn { background-color: #ef4444; /* bg-red-500 */ }
        .delete-btn:hover { background-color: #dc2626; /* bg-red-600 */ }
        .edit-btn { background-color: #f59e0b; /* bg-amber-500 */ }
        .edit-btn:hover { background-color: #d97706; /* bg-amber-600 */ }
        input[type="text"], input[type="number"], select {
            background-color: #374151; /* bg-gray-700 */
            border: 1px solid #4b5563; /* border-gray-600 */
            color: #f3f4f6; /* text-gray-100 */
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        label { margin-bottom: 4px; display: block; font-size: 0.9rem; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-2 sm:p-4 md:p-8">

    <div id="loadingIndicator" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[200]">
        <div class="text-xl font-semibold">Loading Habit Tracker...</div>
    </div>

    <div id="authModal" class="modal z-[150]">
        <div class="modal-content">
            <h2 class="text-xl font-semibold mb-4">Authentication</h2>
            <p id="authMessage">Initializing authentication...</p>
            <p class="mt-2 text-sm text-gray-400">Your User ID: <span id="modalUserId" class="font-mono"></span></p>
        </div>
    </div>

    <div id="tipModal" class="modal z-[160]">
        <div class="modal-content">
            <span class="modal-close-btn" id="closeTipModal">&times;</span>
            <h2 class="text-xl font-semibold mb-3 text-emerald-400">✨ AI Powered Tip!</h2>
            <p id="tipModalContent" class="text-gray-300 leading-relaxed">Loading tip...</p>
        </div>
    </div>

    <div id="habitModal" class="modal z-[170]">
        <div class="modal-content">
            <span class="modal-close-btn" id="closeHabitModal">&times;</span>
            <h2 id="habitModalTitle" class="text-xl font-semibold mb-4">Add New Habit</h2>
            <div>
                <input type="hidden" id="habitEditId">
                <label for="habitNameInput">Habit Name:</label>
                <input type="text" id="habitNameInput" class="w-full" placeholder="e.g., Read for 30 minutes">
                <label for="habitGoalInput">Monthly Goal (days):</label>
                <input type="number" id="habitGoalInput" class="w-full" placeholder="e.g., 20">
                <label for="habitPhaseInput">Phase:</label>
                <select id="habitPhaseInput" class="w-full">
                    <option value="Building">Building</option>
                    <option value="Breaking">Breaking</option>
                </select>
                <button id="saveHabitBtn" class="action-btn mt-4 w-full bg-emerald-500 hover:bg-emerald-600">Save Habit</button>
            </div>
        </div>
    </div>

    <header class="mb-6 text-center">
        <h1 class="text-3xl sm:text-4xl font-bold text-emerald-400">DYNAMIC HABITS TRACKER</h1>
        <p class="text-sm text-gray-400 mt-1">User ID: <span id="displayedUserId" class="font-mono text-xs">Initializing...</span></p>
    </header>

    <div class="mb-8 p-4 bg-gray-800 rounded-lg shadow-lg">
        <div class="flex flex-col sm:flex-row sm:items-end gap-4">
            <div>
                <label for="yearInput" class="text-lg">Year:</label>
                <input type="number" id="yearInput" value="2025" class="w-full sm:w-auto">
            </div>
            <button id="loadYearBtn" class="action-btn bg-sky-500 hover:bg-sky-600 px-4 py-2 text-base">Load Year Data</button>
        </div>
    </div>

    <div class="mb-8 p-4 bg-gray-800 rounded-lg shadow-lg">
        <h2 class="text-2xl font-semibold text-emerald-300 mb-3">Manage Habits for <span id="currentYearDisplayHabitMgmt"></span></h2>
        <div id="habitListContainer" class="mb-4 space-y-2">
            </div>
        <button id="openAddHabitModalBtn" class="action-btn bg-green-500 hover:bg-green-600 text-base">Add New Habit</button>
    </div>


    <div id="monthsContainer" class="space-y-12">
        </div>

    <footer class="mt-12 text-center text-xs text-gray-500">
        <p>Dynamic Habit Tracker. Data stored in Firestore.</p>
        <p>AI Tips powered by Gemini.</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, deleteField, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-dynamic-tracker-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db, userId = null, unsubscribeFirestore = null;
        let isDataInitialized = false;
        let currentYear = new Date().getFullYear(); // Default to current year
        let habitsConfig = []; // This will now hold user-defined habits for the currentYear
        let allHabitDataForYear = {}; // Holds { habitId: { months: { ... } } }

        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        function getDaysInMonth(year, month) { return new Date(year, month + 1, 0).getDate(); }
        function getDayName(year, month, day) { return new Date(year, month, day).toLocaleDateString('en-US', { weekday: 'short' }); }

        const loadingIndicator = document.getElementById('loadingIndicator');
        const monthsContainer = document.getElementById('monthsContainer');
        const displayedUserIdElement = document.getElementById('displayedUserId');
        const currentYearDisplayHabitMgmt = document.getElementById('currentYearDisplayHabitMgmt');
        const authModal = document.getElementById('authModal');
        const authMessage = document.getElementById('authMessage');
        const modalUserId = document.getElementById('modalUserId');
        const tipModal = document.getElementById('tipModal');
        const tipModalContent = document.getElementById('tipModalContent');
        const closeTipModalBtn = document.getElementById('closeTipModal');
        const habitModal = document.getElementById('habitModal');
        const closeHabitModalBtn = document.getElementById('closeHabitModal');
        const habitModalTitle = document.getElementById('habitModalTitle');
        const habitNameInput = document.getElementById('habitNameInput');
        const habitGoalInput = document.getElementById('habitGoalInput');
        const habitPhaseInput = document.getElementById('habitPhaseInput');
        const saveHabitBtn = document.getElementById('saveHabitBtn');
        const openAddHabitModalBtn = document.getElementById('openAddHabitModalBtn');
        const habitListContainer = document.getElementById('habitListContainer');
        const habitEditIdInput = document.getElementById('habitEditId');
        const yearInput = document.getElementById('yearInput');
        const loadYearBtn = document.getElementById('loadYearBtn');


        closeTipModalBtn.onclick = () => tipModal.style.display = "none";
        closeHabitModalBtn.onclick = () => habitModal.style.display = "none";
        window.onclick = (event) => {
            if (event.target == tipModal) tipModal.style.display = "none";
            if (event.target == habitModal) habitModal.style.display = "none";
        };
        openAddHabitModalBtn.onclick = () => openHabitModalForAdd();
        saveHabitBtn.onclick = () => handleSaveHabit();
        loadYearBtn.onclick = () => handleChangeYear();

        async function setupFirebase() {
            yearInput.value = currentYear; // Set initial year in input
            if (!firebaseConfig) {
                console.error("Firebase config missing."); authMessage.textContent = "Error: Firebase config missing.";
                authModal.style.display = "block"; loadingIndicator.style.display = "none"; return;
            }
            try {
                app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); setLogLevel('debug');
                authModal.style.display = "block"; authMessage.textContent = "Authenticating...";
                await setPersistence(auth, browserLocalPersistence);
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid; console.log("User authenticated:", userId);
                        displayedUserIdElement.textContent = userId; modalUserId.textContent = userId;
                        authMessage.textContent = "Authenticated. Loading data...";
                        await loadDataForCurrentYear(); // Load data for the initially set year
                        setTimeout(() => { if(isDataInitialized) authModal.style.display = "none"; }, 1500);
                    } else {
                        authMessage.textContent = "No session. Attempting sign in...";
                        if (initialAuthToken) {
                            try { await signInWithCustomToken(auth, initialAuthToken); }
                            catch (error) { console.error("Token sign-in failed:", error); authMessage.textContent = `Token sign-in failed. Trying anonymous.`; await signInAnonymously(auth); }
                        } else { await signInAnonymously(auth); }
                    }
                });
            } catch (error) {
                console.error("Firebase init error:", error); authMessage.textContent = `Firebase init failed: ${error.message}`;
                loadingIndicator.style.display = "none"; authModal.style.display = "block";
            }
        }
        
        async function handleChangeYear() {
            const newYear = parseInt(yearInput.value);
            if (isNaN(newYear) || newYear < 1900 || newYear > 2200) {
                alert("Please enter a valid year (e.g., 2024)."); // Using alert for simplicity here, ideally a custom modal
                return;
            }
            currentYear = newYear;
            loadingIndicator.style.display = "flex"; // Show loading indicator
            await loadDataForCurrentYear();
        }

        async function loadDataForCurrentYear() {
            if (!userId || !db) { console.error("User/DB not ready."); loadingIndicator.style.display = "none"; return; }
            
            currentYearDisplayHabitMgmt.textContent = currentYear; // Update year display in habit management section

            const docRef = doc(db, "artifacts", appId, "users", userId, "habitsTrackerData", `userData_${currentYear}`);
            if (unsubscribeFirestore) unsubscribeFirestore();

            unsubscribeFirestore = onSnapshot(docRef, (docSnap) => {
                isDataInitialized = false; // Reset before loading new year's data
                habitsConfig = [];
                allHabitDataForYear = {};

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    habitsConfig = data.habitDefinitions || []; // Load habit definitions for the year
                    allHabitDataForYear = data.habitTrackingData || {}; // Load tracking data
                    console.log(`Data loaded for ${currentYear}:`, habitsConfig, allHabitDataForYear);
                } else {
                    console.log(`No data found for ${currentYear}. User can add habits.`);
                    // If no data, habitsConfig and allHabitDataForYear remain empty.
                    // We won't create a doc here; it'll be created when the first habit is added or tracked.
                }
                initializeAndNormalizeData(); // Ensure data structure is consistent
                isDataInitialized = true;
                renderApp();
                loadingIndicator.style.display = "none";
                if (authModal.style.display === "block" && authMessage.textContent.includes("Loading data...")) {
                     authMessage.textContent = "Data loaded!"; setTimeout(() => { authModal.style.display = "none"; }, 1000);
                }
            }, (error) => {
                console.error(`Error getting document for year ${currentYear}:`, error);
                authMessage.textContent = `Error loading data: ${error.message}`;
                loadingIndicator.style.display = "none";
                habitsConfig = []; allHabitDataForYear = {}; // Clear data on error
                renderApp(); // Render empty state or error message
            });
        }

        function initializeAndNormalizeData() {
            // Ensure every habit in habitsConfig has tracking data structure in allHabitDataForYear
            habitsConfig.forEach(habitDef => {
                if (!allHabitDataForYear[habitDef.id]) {
                    allHabitDataForYear[habitDef.id] = { months: {} };
                }
                const habitTracking = allHabitDataForYear[habitDef.id];
                if (!habitTracking.months) habitTracking.months = {};

                monthNames.forEach((_, monthIndex) => {
                    const monthKey = `${currentYear}-${String(monthIndex + 1).padStart(2, '0')}`;
                    const daysInThisMonth = getDaysInMonth(currentYear, monthIndex);
                    if (!habitTracking.months[monthKey] || habitTracking.months[monthKey].days.length !== daysInThisMonth) {
                        habitTracking.months[monthKey] = { days: Array(daysInThisMonth).fill(false), total: 0, currentStreak: 0, longestStreak: 0 };
                    }
                });
            });
        }


        async function saveDataToFirestore() {
            if (!userId || !db || !isDataInitialized) { console.warn("User/DB/Data not ready for saving."); return; }
            const docRef = doc(db, "artifacts", appId, "users", userId, "habitsTrackerData", `userData_${currentYear}`);
            try {
                // We store habit definitions and their tracking data separately under the year's document
                await setDoc(docRef, {
                    year: currentYear,
                    habitDefinitions: habitsConfig, // Array of {id, name, monthlyGoal, phase}
                    habitTrackingData: allHabitDataForYear // Object { habitId: { months: { ... } } }
                }, { merge: true });
                console.log(`Data saved for year ${currentYear}.`);
            } catch (error) { console.error("Error saving data: ", error); }
        }
        
        function openHabitModalForAdd() {
            habitModalTitle.textContent = "Add New Habit";
            habitEditIdInput.value = ""; // Clear edit ID
            habitNameInput.value = "";
            habitGoalInput.value = "";
            habitPhaseInput.value = "Building";
            habitModal.style.display = "block";
        }

        function openHabitModalForEdit(habitId) {
            const habitToEdit = habitsConfig.find(h => h.id === habitId);
            if (!habitToEdit) return;
            habitModalTitle.textContent = "Edit Habit";
            habitEditIdInput.value = habitId;
            habitNameInput.value = habitToEdit.name;
            habitGoalInput.value = habitToEdit.monthlyGoal;
            habitPhaseInput.value = habitToEdit.phase;
            habitModal.style.display = "block";
        }

        async function handleSaveHabit() {
            const name = habitNameInput.value.trim();
            const monthlyGoal = parseInt(habitGoalInput.value);
            const phase = habitPhaseInput.value;
            const editId = habitEditIdInput.value;

            if (!name || isNaN(monthlyGoal) || monthlyGoal <= 0) {
                alert("Please enter valid habit details."); // Simplistic alert
                return;
            }

            if (editId) { // Editing existing habit
                const habitIndex = habitsConfig.findIndex(h => h.id === editId);
                if (habitIndex > -1) {
                    habitsConfig[habitIndex] = { ...habitsConfig[habitIndex], name, monthlyGoal, phase };
                }
            } else { // Adding new habit
                const newHabit = { id: crypto.randomUUID(), name, monthlyGoal, phase };
                habitsConfig.push(newHabit);
                // Ensure tracking data structure is created for the new habit
                if (!allHabitDataForYear[newHabit.id]) {
                    allHabitDataForYear[newHabit.id] = { months: {} };
                    initializeAndNormalizeData(); // Re-run to setup months for this new habit
                }
            }
            await saveDataToFirestore();
            renderHabitList(); // Update the list of habits in manage section
            renderApp(); // Re-render the main tracker tables
            habitModal.style.display = "none";
        }

        async function handleDeleteHabit(habitId) {
            // Basic confirmation, ideally a custom modal
            if (!confirm("Are you sure you want to delete this habit and all its tracking data for this year?")) return;

            habitsConfig = habitsConfig.filter(h => h.id !== habitId);
            // Remove tracking data for this habit
            delete allHabitDataForYear[habitId]; 

            // To remove from Firestore, we need to update the document and delete the specific field
            const docRef = doc(db, "artifacts", appId, "users", userId, "habitsTrackerData", `userData_${currentYear}`);
            const updates = {};
            updates[`habitTrackingData.${habitId}`] = deleteField(); // This is how you delete a map field

            try {
                await updateDoc(docRef, updates); // First, delete the tracking data field
                await setDoc(docRef, { habitDefinitions: habitsConfig }, { merge: true }); // Then, update the definitions
                console.log(`Habit ${habitId} and its tracking data deleted for year ${currentYear}.`);
            } catch (error) {
                console.error(`Error deleting habit ${habitId}:`, error);
                // If deletion fails, we might want to revert local changes or retry, but for now, log it.
                // For robustness, one might reload data from Firestore here to ensure consistency.
            }
            
            renderHabitList();
            renderApp();
        }


        function calculateAllStats(habitId, monthKey) {
            const habitDef = habitsConfig.find(h => h.id === habitId);
            const habitTracking = allHabitDataForYear[habitId];
            if (!habitDef || !habitTracking || !habitTracking.months[monthKey]) return;

            const monthData = habitTracking.months[monthKey];
            const daysArray = monthData.days;
            monthData.total = daysArray.filter(done => done).length;
            let longestStreak = 0, currentRun = 0;
            for (const dayDone of daysArray) { if (dayDone) currentRun++; else { longestStreak = Math.max(longestStreak, currentRun); currentRun = 0; } }
            monthData.longestStreak = Math.max(longestStreak, currentRun);
            let currentStreak = 0; const today = new Date();
            const [yearStr, monthStr] = monthKey.split('-'); const monthYear = parseInt(yearStr), monthIndex = parseInt(monthStr) - 1;
            let lastRelevantDayIndex = daysArray.length - 1;
            if (monthYear === today.getFullYear() && monthIndex === today.getMonth() && monthYear === currentYear) lastRelevantDayIndex = today.getDate() - 1;
            else if (new Date(monthYear, monthIndex) > today || monthYear !== currentYear) lastRelevantDayIndex = -1; // Also for future years relative to currentYear
            for (let i = lastRelevantDayIndex; i >= 0; i--) { if (daysArray[i]) currentStreak++; else break; }
            if(lastRelevantDayIndex < 0) currentStreak = 0;
            monthData.currentStreak = currentStreak;
        }

        function renderApp() {
            if (!isDataInitialized) { loadingIndicator.style.display = "block"; return; }
            loadingIndicator.style.display = "none"; monthsContainer.innerHTML = '';
            renderHabitList(); // Render the editable habit list
            monthNames.forEach((monthName, monthIndex) => { monthsContainer.appendChild(renderMonth(monthIndex, monthName, currentYear)); });
        }
        
        function renderHabitList() {
            habitListContainer.innerHTML = ''; // Clear existing list
            if (habitsConfig.length === 0) {
                habitListContainer.innerHTML = `<p class="text-gray-400">No habits defined for ${currentYear}. Add one below!</p>`;
                return;
            }
            const ul = document.createElement('ul');
            ul.className = 'space-y-2';
            habitsConfig.forEach(habit => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-3 bg-gray-700 rounded-md';
                li.innerHTML = `
                    <span class="font-medium">${habit.name} (Goal: ${habit.monthlyGoal}, Phase: ${habit.phase})</span>
                    <div>
                        <button class="action-btn edit-btn text-xs mr-2" data-habit-id="${habit.id}">Edit</button>
                        <button class="action-btn delete-btn text-xs" data-habit-id="${habit.id}">Delete</button>
                    </div>
                `;
                li.querySelector('.edit-btn').addEventListener('click', (e) => openHabitModalForEdit(e.target.dataset.habitId));
                li.querySelector('.delete-btn').addEventListener('click', (e) => handleDeleteHabit(e.target.dataset.habitId));
                ul.appendChild(li);
            });
            habitListContainer.appendChild(ul);
        }


        function renderMonth(monthIndex, monthName, year) {
            const monthDiv = document.createElement('div');
            monthDiv.className = 'mb-8 p-3 sm:p-4 bg-gray-800 rounded-lg shadow-xl';
            monthDiv.innerHTML = `<h2 class="text-2xl font-semibold text-emerald-300 mb-4 text-center">${monthName} ${year}</h2>`;
            const tableContainer = document.createElement('div'); tableContainer.className = 'table-container';
            const table = document.createElement('table'); table.className = 'w-full';
            const daysInThisMonth = getDaysInMonth(year, monthIndex); const today = new Date();
            const isCurrentMonthForToday = today.getFullYear() === year && today.getMonth() === monthIndex; const todayDate = today.getDate();
            
            const thead = table.createTHead(); const headerRowTop = thead.insertRow(); headerRowTop.className = "sticky-header";
            const headerRowBottom = thead.insertRow(); headerRowBottom.className = "sticky-header";
            const thHabitTop = document.createElement('th'); thHabitTop.textContent = 'Habit'; thHabitTop.rowSpan = 2; thHabitTop.className = 'sticky-col habit-name-col'; headerRowTop.appendChild(thHabitTop);
            for (let day = 1; day <= daysInThisMonth; day++) {
                const thDayNum = document.createElement('th'); thDayNum.textContent = day; thDayNum.className = 'day-header';
                const thDayName = document.createElement('th'); const dayNameStr = getDayName(year, monthIndex, day); thDayName.textContent = dayNameStr; thDayName.className = 'day-header';
                if (dayNameStr === 'Sat' || dayNameStr === 'Sun') { thDayNum.classList.add('weekend'); thDayName.classList.add('weekend'); }
                if (isCurrentMonthForToday && day === todayDate) { thDayNum.classList.add('today'); thDayName.classList.add('today'); }
                headerRowTop.appendChild(thDayNum); headerRowBottom.appendChild(thDayName);
            }
            ['Total', 'Current', 'Longest', 'Goal', 'Phase', '✨ AI Tip'].forEach(statName => {
                const thStat = document.createElement('th'); thStat.textContent = statName; thStat.rowSpan = 2;
                thStat.className = statName === '✨ AI Tip' ? 'action-col' : 'stats-col'; headerRowTop.appendChild(thStat);
            });
            const tbody = table.createTBody();
            if (habitsConfig.length === 0) {
                const trEmpty = tbody.insertRow();
                const tdEmpty = trEmpty.insertCell();
                tdEmpty.colSpan = daysInThisMonth + 1 + 5; // Habit name + days + stats + AI tip
                tdEmpty.textContent = `No habits defined for ${year}. Add habits in the 'Manage Habits' section.`;
                tdEmpty.className = "text-center py-4 text-gray-400";
            } else {
                habitsConfig.forEach(habitDef => {
                    const monthKey = `${year}-${String(monthIndex + 1).padStart(2, '0')}`;
                    const habitTracking = allHabitDataForYear[habitDef.id];
                    const habitMonthData = habitTracking?.months?.[monthKey];

                    if (!habitMonthData) { console.warn(`No month data for ${habitDef.id} in ${monthKey}`); return; } // Should be initialized

                    const tr = tbody.insertRow();
                    const tdHabitName = tr.insertCell(); tdHabitName.textContent = habitDef.name; tdHabitName.className = 'sticky-col habit-name-col text-left py-2 px-3 text-sm';
                    for (let day = 0; day < daysInThisMonth; day++) {
                        const tdDay = tr.insertCell(); tdDay.className = 'checkbox-cell day-cell';
                        const dayNameStr = getDayName(year, monthIndex, day + 1);
                        if (dayNameStr === 'Sat' || dayNameStr === 'Sun') tdDay.classList.add('weekend');
                        if (isCurrentMonthForToday && (day + 1) === todayDate) tdDay.classList.add('today');
                        const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.checked = habitMonthData.days[day];
                        Object.assign(checkbox.dataset, { habitId: habitDef.id, monthKey: monthKey, dayIndex: day });
                        checkbox.addEventListener('change', handleCheckboxChange); tdDay.appendChild(checkbox);
                    }
                    tr.insertCell().textContent = habitMonthData.total; tr.insertCell().textContent = habitMonthData.currentStreak;
                    tr.insertCell().textContent = habitMonthData.longestStreak; tr.insertCell().textContent = habitDef.monthlyGoal;
                    tr.insertCell().textContent = habitDef.phase;
                    const tdAction = tr.insertCell(); tdAction.className = 'action-cell';
                    const tipButton = document.createElement('button'); tipButton.innerHTML = 'Get Tip ✨'; tipButton.className = 'ai-tip-btn';
                    Object.assign(tipButton.dataset, { habitId: habitDef.id, habitName: habitDef.name, habitPhase: habitDef.phase });
                    tipButton.addEventListener('click', () => fetchMotivationalTip(tipButton.dataset.habitId, tipButton.dataset.habitName, tipButton.dataset.habitPhase, tipButton));
                    tdAction.appendChild(tipButton);
                });
            }
            tableContainer.appendChild(table); monthDiv.appendChild(tableContainer); return monthDiv;
        }

        function handleCheckboxChange(event) {
            const { habitId, monthKey, dayIndex } = event.target.dataset;
            const habitTracking = allHabitDataForYear[habitId];
            if (habitTracking && habitTracking.months[monthKey]) {
                habitTracking.months[monthKey].days[parseInt(dayIndex)] = event.target.checked;
                calculateAllStats(habitId, monthKey); saveDataToFirestore();
                renderApp(); 
            }
        }

        async function fetchMotivationalTip(habitId, habitName, habitPhase, buttonElement) {
            tipModalContent.textContent = "Generating your motivational tip..."; tipModal.style.display = "block";
            buttonElement.disabled = true; buttonElement.textContent = "Loading...";
            const promptType = habitPhase === "Breaking" ? "breaking" : "building";
            const prompt = `Generate a short, actionable, and encouraging tip for someone trying to ${promptType === "breaking" ? "break the habit" : "build the habit"} of "${habitName}". Keep the tip to 1-2 concise sentences.`;
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }]; const payload = { contents: chatHistory };
            const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const errorData = await response.json(); throw new Error(`API Error ${response.status}: ${errorData.error?.message || 'Unknown'}`); }
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    tipModalContent.textContent = result.candidates[0].content.parts[0].text;
                } else { throw new Error("Unexpected API response structure."); }
            } catch (error) { console.error('Error fetching tip:', error); tipModalContent.textContent = `Sorry, couldn't fetch a tip. ${error.message}`; }
            finally { buttonElement.disabled = false; buttonElement.innerHTML = 'Get Tip ✨'; }
        }

        window.onload = async () => {
            currentYearDisplayHabitMgmt.textContent = currentYear;
            await setupFirebase();
        };
    </script>
</body>
</html>
